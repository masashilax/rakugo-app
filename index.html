<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お買い物リスト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SortableJS: スマホでのドラッグ操作を安定させるライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* ドラッグ中の見た目調整 */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e5e7eb; /* グレーにして移動先をわかりやすく */
        }
        .sortable-chosen {
            background-color: #f0fdfa; /* 掴んでいる間は少し色を変える（薄いティール） */
        }
        /* スクロールバーをスマートに */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        /* テキスト選択防止（ドラッグ時の誤操作防止） */
        .no-select {
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen pb-32">

    <!-- Header: z-50を追加して最前面に固定 -->
    <header class="fixed top-0 left-0 right-0 bg-teal-600 text-white shadow-md z-50 transition-all duration-300">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-wide"><i class="fas fa-clipboard-list mr-2"></i>お買い物リスト</h1>
            <button onclick="clearList()" class="text-xs bg-teal-700/80 hover:bg-teal-800 px-3 py-1.5 rounded text-white transition">
                全消去
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto pt-20 px-4">
        <!-- List Container -->
        <ul id="shopping-list" class="space-y-3 pb-4">
            <!-- JavaScriptでここにリストが生成されます -->
        </ul>
        
        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center mt-20 text-gray-400">
            <div class="inline-block p-4 rounded-full bg-gray-100 mb-3">
                <i class="fas fa-basket-shopping text-4xl text-gray-300"></i>
            </div>
            <p class="text-sm">リストは空っぽです</p>
        </div>
    </main>

    <!-- Bottom Input Area -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-gray-200 p-4 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="max-w-md mx-auto flex gap-2">
            <input type="text" id="new-item-input" 
                class="flex-1 bg-gray-100 border-0 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:bg-white transition-all text-base placeholder-gray-400" 
                placeholder="追加するものを入力..."
                autocomplete="off"
                onkeypress="if(event.key === 'Enter') addItem()">
            <button onclick="addItem()" 
                class="bg-teal-600 text-white rounded-xl px-5 py-3 font-bold hover:bg-teal-700 active:scale-95 transition flex items-center shadow-md shadow-teal-200">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <script>
        // データ管理
        let items = JSON.parse(localStorage.getItem('shoppingList')) || [
            { id: '1', text: '牛乳', completed: false },
            { id: '2', text: '卵パック', completed: false },
            { id: '3', text: '洗剤', completed: true },
        ];

        const listElement = document.getElementById('shopping-list');
        const emptyState = document.getElementById('empty-state');
        const inputElement = document.getElementById('new-item-input');

        // 描画関数
        function render() {
            listElement.innerHTML = '';
            
            if (items.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.dataset.id = item.id;
                    // カードのデザイン: タッチ操作しやすいようにパディング確保
                    li.className = `bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group touch-manipulation transition-all duration-200 no-select ${item.completed ? 'bg-gray-50/80' : ''}`;
                    
                    li.innerHTML = `
                        <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="toggleComplete('${item.id}')">
                            <div class="relative w-6 h-6 flex-shrink-0">
                                <div class="w-6 h-6 rounded-full border-2 transition-colors duration-200 flex items-center justify-center
                                    ${item.completed ? 'bg-teal-500 border-teal-500' : 'border-gray-300 hover:border-teal-400'}">
                                    ${item.completed ? '<i class="fas fa-check text-white text-[10px]"></i>' : ''}
                                </div>
                            </div>
                            <span class="text-base font-medium leading-relaxed break-all ${item.completed ? 'text-gray-400 line-through decoration-gray-300' : 'text-gray-700'}">
                                ${item.text}
                            </span>
                        </div>
                        <button onclick="deleteItem('${item.id}')" class="text-gray-300 hover:text-red-500 p-2 -mr-2 transition-colors focus:outline-none active:text-red-600">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    listElement.appendChild(li);
                });
            }
            save();
        }

        // アイテム追加
        function addItem() {
            const text = inputElement.value.trim();
            if (!text) return;
            
            const newItem = {
                id: Date.now().toString(),
                text: text,
                completed: false
            };
            
            items.push(newItem);
            inputElement.value = '';
            render();
            
            // 追加後に一番下へスクロール
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        // 完了状態の切り替え
        function toggleComplete(id) {
            const index = items.findIndex(i => i.id === id);
            if (index > -1) {
                items[index].completed = !items[index].completed;
                render();
            }
        }

        // 削除
        function deleteItem(id) {
            if (navigator.vibrate) navigator.vibrate(10); // 軽い振動フィードバック
            items = items.filter(i => i.id !== id);
            render();
        }

        // 全削除
        function clearList() {
            if(items.length === 0) return;
            if(confirm('リストを空にしますか？')) {
                items = [];
                render();
            }
        }

        // 保存
        function save() {
            localStorage.setItem('shoppingList', JSON.stringify(items));
        }

        // ドラッグ＆ドロップの初期化（ここが修正のキモです）
        new Sortable(listElement, {
            animation: 200,      // アニメーション速度
            delay: 150,          // 【重要】0.15秒長押しでドラッグ開始（スクロール誤爆防止）
            delayOnTouchOnly: true, // タッチデバイスのみ遅延を有効にする
            ghostClass: 'sortable-ghost', // 移動先のプレースホルダー用クラス
            chosenClass: 'sortable-chosen', // 掴んでいる時のクラス
            dragClass: 'sortable-drag', // ドラッグ中のクラス
            onEnd: function (evt) {
                // 並び替え後のデータを保存
                const newItems = [];
                const listItems = listElement.querySelectorAll('li');
                listItems.forEach(li => {
                    const id = li.dataset.id;
                    const item = items.find(i => i.id === id);
                    if (item) newItems.push(item);
                });
                items = newItems;
                save();
            }
        });

        // 初回描画
        render();

    </script>
</body>
</html>
